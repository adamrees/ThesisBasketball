---
title: "Thesis"
author: "Adam Rees"
date: "October 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rvest)
library(dplyr)
require(XML)
require(RCurl)
require(stringr)
require(png)
library(XML)

library(sp)
library(gstat)

#install.packages('rapportools')
library(rapportools)

```


Getting the original data up. Pull in what URL you want and work from there
```{r}
#url <- getURL("https://sports.yahoo.com/nba/los-angeles-lakers-golden-state-warriors-2019100509/?section=gamestream")

#URL for the livestream
url <- getURL("https://sports.yahoo.com/nba/los-angeles-clippers-phoenix-suns-2019102621/?section=gamestream")

#Character where JUMPBALL happened
postJump <- gregexpr("JUMPBALL", url)

#the string before the JUMPBALL - needed to get the starters
starterStuff <- substr(url, 1, postJump)
players <- gregexpr("on_court", starterStuff)
playerIDs <- c()
starters <- c()

for(i in 1:length(players[[1]])){

#get all of the players IDS
playerIDs[i] <- substr(starterStuff, players[[1]][i] - 7, players[[1]][i] -4)

checkStarter <- substr(starterStuff, players[[1]][i] + 23, players[[1]][i] + 23)

#Identify if they are a starter or not
if(grepl(checkStarter, "0")){
  starters[i] <- FALSE
  } else{
  starters[i] <- TRUE
}
}


startingLineups <- data.frame(playerIDs, starters)
justStarters <- startingLineups %>% filter(starters == TRUE)
startingIDs <- c()
for(i in 1:nrow(justStarters)){
  startingIDs[i] <- toString(justStarters$playerIDs[i])
}
startingIDs

#We only want the data after the jump for the gameStream
data <- substr(url, postJump[[1]], nchar(url))
```


```{r}

#Get all of the characters where shots were taken
shots <- gregexpr("SHOT", data)


newShots <- shots[[1]]
subs <- gregexpr("SUB", data)


#get rid of the NAs
newShots <- newShots[!is.na(newShots)]

#all of the characters where player is mentioned (could be for anything)
player <- gregexpr("player", data)
shotChar <- c()

#Match the player to the shooter
for (i in 1:length(newShots)){
  shotChar[i] <- player[[1]][which(player[[1]] > newShots[i] & player[[1]] < newShots[i]+47)]
}


shooterID <- c()
for(i in 1:length(shotChar)){
  shooterID[i] <- substr(data,shotChar[i]+9,shotChar[i]+12)
}

#data frame with every single shot and who shot it
shotAndShooter <- tibble(shotChar, shooterID)

#you can add a filter here
shotLocations <- shotAndShooter
```


shotLocations$H1 <- justStarters$playerIDs[[1]]
shotLocations$H2 <- justStarters$playerIDs[[2]]
shotLocations$H3 <- justStarters$playerIDs[[3]]
shotLocations$H4 <- justStarters$playerIDs[[4]]
shotLocations$H5 <- justStarters$playerIDs[[5]]
shotLocations$A1 <- justStarters$playerIDs[[6]]
shotLocations$A2 <- justStarters$playerIDs[[7]]
shotLocations$A3 <- justStarters$playerIDs[[8]]
shotLocations$A4 <- justStarters$playerIDs[[9]]
shotLocations$A5 <- justStarters$playerIDs[[10]]


Currently: getting NAs on the enter player and leave player. need to get the leave and enter player better like grab the whole string and work from there
```{r}
#We want to initialize the starters
shotLocations$H1<- ""
    shotLocations$H2<- ""
    shotLocations$H3<- ""
    shotLocations$H4<- ""
    shotLocations$H5<- ""
    shotLocations$A1<- ""
    shotLocations$A2<- ""
    shotLocations$A3<- ""
    shotLocations$A4<- ""
    shotLocations$A5<- ""
    
    

#number of shots taken in the game
numShots <- nrow(shotLocations)


subsCounter <- 1
l <- 1

for(i in 1:numShots){

  if(i == 1){
    shotLocations$H1[1]<- startingIDs[1]
    shotLocations$H2[1]<- startingIDs[2]
    shotLocations$H3[1]<- startingIDs[3]
    shotLocations$H4[1]<- startingIDs[4]
    shotLocations$H5[1]<- startingIDs[5]
    shotLocations$A1[1]<- startingIDs[6]
    shotLocations$A2[1]<- startingIDs[7]
    shotLocations$A3[1]<- startingIDs[8]
    shotLocations$A4[1]<- startingIDs[9]
    shotLocations$A5[1]<- startingIDs[10]
  }
  else{
    
#Do we need to make a sub?
    if(!is.na(subs[[1]][subsCounter]) && as.numeric(subs[[1]][subsCounter] < as.numeric(shotLocations$shotChar[i]))){
  
      
  while(!is.na(subs[[1]][subsCounter + 1]) &&
    as.numeric(subs[[1]][subsCounter] < as.numeric(shotLocations$shotChar[i]))){
    
      l <- l + 1

    #find the players that are getting subbed in and subbed out
findPlayer <- substr(data, subs[[1]][l], subs[[1]][l] + 150)
findPlayer
playerEnter <- gregexpr("enter_player", findPlayer)
playerLeave <- gregexpr("leave_player", findPlayer)

enterPlayer <- substr(findPlayer, playerEnter[[1]] + 15, playerEnter[[1]] + 18)
leavePlayer <- substr(findPlayer, playerLeave[[1]] + 15, playerLeave[[1]] + 18)
    
    if(shotLocations$H1[i-1] == leavePlayer){
      shotLocations$H1[i] <- enterPlayer
    }
    if(shotLocations$H2[i-1] == leavePlayer){
      shotLocations$H2[i] <- enterPlayer
    }
    if(shotLocations$H3[i-1] == leavePlayer){
      shotLocations$H3[i] <- enterPlayer
    }
    if(shotLocations$H4[i-1] == leavePlayer){
      shotLocations$H4[i] <- enterPlayer
    }
    if(shotLocations$H5[i-1] == leavePlayer){
      shotLocations$H5[i] <- enterPlayer
    }
    if(shotLocations$A1[i-1] == leavePlayer){
      shotLocations$A1[i] <- enterPlayer
    }
    if(shotLocations$A2[i-1] == leavePlayer){
      shotLocations$A2[i] <- enterPlayer
    }
    if(shotLocations$A3[i-1] == leavePlayer){
      shotLocations$A3[i] == enterPlayer
    }
    if(shotLocations$A4[i-1] == leavePlayer){
      shotLocations$A4[i] == enterPlayer
    }
    if(shotLocations$A4[i-1] == leavePlayer){
      shotLocations$A4[i] == enterPlayer
    }
    if(shotLocations$A5[i-1] == leavePlayer){
      shotLocations$A5[i] == enterPlayer
    }
    
    subsCounter <- subsCounter + 1
}
    }
  
  else{
    #There has not been a sub since the last shot
    shotLocations$H1[i] <- shotLocations$H1[i-1]
    shotLocations$H2[i] <- shotLocations$H2[i-1]
    shotLocations$H3[i] <- shotLocations$H3[i-1]
    shotLocations$H4[i] <- shotLocations$H4[i-1]
    shotLocations$H5[i] <- shotLocations$H5[i-1]
    shotLocations$A1[i] <- shotLocations$A1[i-1]
    shotLocations$A2[i] <- shotLocations$A2[i-1]
    shotLocations$A3[i] <- shotLocations$A3[i-1]
    shotLocations$A4[i] <- shotLocations$A4[i-1]
    shotLocations$A5[i] <- shotLocations$A4[i-1]
  }
  }
  
   

     
  
  
  
fullString <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 450)

timeChr <- gregexpr("clock", fullString)
findTime <- substr(fullString, timeChr[[1]]+8, timeChr[[1]] + 12)

if(!substr(findTime, 1, 1) == "1" | substr(findTime, 1, 2) == "1:"){
  findTime <- substr(findTime, 1, 4)
}
if(substr(findTime, 1, 1) == ":"){
  findTime <- paste("0", substr(findTime, 1, 3), sep = "") 
}

shotLocations$Time[i] <- findTime

periodChr <- gregexpr("period", fullString)
findPeriod <- substr(fullString, periodChr[[1]]+9, periodChr[[1]] + 9)

shotLocations$Period[i] <- findPeriod


# Find the score for the home team
homescoreChr <- gregexpr("home_score", fullString)
findHomeScore <- substr(fullString, homescoreChr[[1]]+13, homescoreChr[[1]] + 15)
if(grepl(",", findHomeScore)){
  findComma <- gregexpr(",", findHomeScore)
  findHomeScore <- substr(findHomeScore, 1, findComma[[1]] - 2)
}
x <- substr(findHomeScore, 3, 3)
if(is.na(as.numeric(x)) & !is.empty(x)){
  findHomeScore <- substr(findHomeScore, 1, 2)
}

shotLocations$HomeScore[i] <- findHomeScore

awayScoreChr <- gregexpr("away_score", fullString)
findAwayScore <- substr(fullString, awayScoreChr[[1]] + 13, awayScoreChr[[1]] + 18)


if(grepl(",", findAwayScore)){
  findComma <- gregexpr(",", findAwayScore)
  findAwayScore <- substr(findAwayScore, 1, findComma[[1]] - 2)
}

#x <- substr(findAwayScore, 3, 3)
#if(is.na(as.numeric(x)) & !is.empty(x)){
#  findAwayScore <- substr(findAwayScore, 1, 2)
#}

shotLocations$AwayScore[i] <- findAwayScore


    
#Find the baseline offset by getting a large string after the shot, finding where it says baseline offset and taking the number after it
findBaseline <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 120)
charBaseline <- gregexpr("baseline_offset", findBaseline)
baseString <- substr(findBaseline, charBaseline[[1]] + 28, charBaseline[[1]] + 34)

#baseline offset could be 0 to 4 characters - we want to just grab the number
if(grepl(",", baseString)){
  findComma <- gregexpr(",", baseString)
  baseString <- substr(baseString, 1, findComma[[1]] - 1)
}

#Same code but now for sideline offset
findSideline <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 300)
charSideline <- gregexpr("sideline_offset", findSideline)
sideString <- substr(findSideline, charSideline[[1]] + 28, charSideline[[1]] + 33)

if(grepl(",", sideString)){
 findComma <- gregexpr(",", sideString)
 sideString <- substr(sideString, 1, findComma[[1]] - 1)
}
 
#they were characters but we want it to be a double
shotLocations$baselineOffset[i] <- as.numeric(baseString)
shotLocations$sidelineOffset[i] <- as.numeric(sideString)

#find if the shot was made or missed
findMakeMiss <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 460)
makeMiss <- gregexpr("shot_made", findMakeMiss)
makeMiss <- substr(findMakeMiss, makeMiss[[1]] + 12, makeMiss[[1]] + 12)

#find what team the player was on
findTeam <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 460)
teamCharacter <- gregexpr("team", findTeam)
team <- substr(findTeam, teamCharacter[[1]] + 7, teamCharacter[[1]] + 8)

if(grepl(",", team)){
 findComma <- gregexpr(",", team)
 team <- substr(team, 1, findComma[[1]] - 1)
}

shotLocations$Team[i] <- team

if(makeMiss == "1"){
  shotLocations$MakeMiss[i] <- 1
} else{
  shotLocations$MakeMiss[i] <- 0
}

#we now need to find what side of the basket the shot was taken. This is needed because the baseline offset is the same number for different sides of the basket
shotLocations$sideBasket[i] <- substr(data, shotLocations$shotChar[i] + 62, shotLocations$shotChar[i] + 62)

#use this to create a new variable plotting the X Location
if(shotLocations$sideBasket[i] == 'R'){
  shotLocations$X_LOC[i] <- as.double(shotLocations$baselineOffset[i] * 500)
} else{
  shotLocations$X_LOC[i] <- as.double(-1 * shotLocations$baselineOffset[i] * 500)
}

#also want the y location
shotLocations$Y_LOC[i] <- shotLocations$sidelineOffset[i] * 850

}

#get the home and away teams
teams <- unique(shotLocations$Team)
#set the opposing team
shotLocations$OpposingTeam <- ifelse(shotLocations$Team == teams[1], teams[2], teams[1])


#even after the for loop some X vals where characters - make sure they are doubles
shotLocations$X_LOC <- as.double(shotLocations$X_LOC)




#Filter out Free Throws
shotsNoFT <- shotLocations %>% filter(!(shotLocations$sidelineOffset == 0.1573 & shotLocations$baselineOffset == 0.00))


#coordinates(shotsNoFT) <- ~X_LOC + Y_LOC
makes <- shotsNoFT %>% filter(shotsNoFT$MakeMiss == 1)
misses <- shotsNoFT %>% filter(shotsNoFT$MakeMiss == 0)


coordinates(makes) <- ~X_LOC + Y_LOC
coordinates(misses) <- ~X_LOC + Y_LOC

plot(makes, pch = 1)
points(misses, pch = 4)


shotsNoFT



shotLocations

```



```{r}
fullString <- substr(data, shotLocations$shotChar[10], shotLocations$shotChar[10] + 450)
awayScoreChr <- gregexpr("away_score", fullString)
findAwayScore <- substr(fullString, awayScoreChr[[1]] + 13, awayScoreChr[[1]] + 18)

findAwayScore
if(grepl(",", findAwayScore)){
  findComma <- gregexpr(",", findAwayScore)
  findAwayScore <- substr(findAwayScore, 1, findComma[[1]] - 2)
}
findAwayScore


```

```{r}

for(i in 1:numShots){

#initialize the starters - there is a chance this will run into a problem if someone subs out before the first shot.
  if(i == 1){
    shotLocations$H1[i] <- justStarters$playerIDs[[1]]
    shotLocations$H2[i] <- justStarters$playerIDs[[2]]
    shotLocations$H3[i] <- justStarters$playerIDs[[3]]
    shotLocations$H4[i] <- justStarters$playerIDs[[4]]
    shotLocations$H5[i] <- justStarters$playerIDs[[5]]
    shotLocations$A1[i] <- justStarters$playerIDs[[6]]
    shotLocations$A2[i] <- justStarters$playerIDs[[7]]
    shotLocations$A3[i] <- justStarters$playerIDs[[8]]
    shotLocations$A4[i] <- justStarters$playerIDs[[9]]
    shotLocations$A5[i] <- justStarters$playerIDs[[10]]
  }else{
    #not the first shot
  
    if(!is.na(subs[[1]][subsCounter]) && as.numeric(subs[[1]][subsCounter] < as.numeric(shotLocations$shotChar[i]))){
  

  while(!is.na(subs[[1]][subsCounter + 1]) &&
    as.numeric(subs[[1]][subsCounter] < as.numeric(shotLocations$shotChar[i]))){
    
      l <- l + 1


    #find the players that are getting subbed in and subbed out
findPlayer <- substr(data, subs[[1]][8], subs[[1]][8] + 150)
findPlayer
playerEnter <- gregexpr("enter_player", findPlayer)
playerLeave <- gregexpr("leave_player", findPlayer)

enterPlayer <- substr(findPlayer, playerEnter[[1]] + 15, playerEnter[[1]] + 18)
leavePlayer <- substr(findPlayer, playerLeave[[1]] + 15, playerLeave[[1]] + 18)
    
    

    if(shotLocations$H1[i-1] == leavePlayer){
      shotLocations$H1[i] <- enterPlayer
    }
    if(shotLocations$H2[i-1] == leavePlayer){
      shotLocations$H2[i] <- enterPlayer
    }
    if(shotLocations$H3[i-1] == leavePlayer){
      shotLocations$H3[i] <- enterPlayer
    }
    if(shotLocations$H4[i-1] == leavePlayer){
      shotLocations$H4[i] <- enterPlayer
    }
    if(shotLocations$H5[i-1] == leavePlayer){
      shotLocations$H5[i] <- enterPlayer
    }
    if(shotLocations$A1[i-1] == leavePlayer){
      shotLocations$A1[i] <- enterPlayer
    }
    if(shotLocations$A2[i-1] == leavePlayer){
      shotLocations$A2[i] <- enterPlayer
    }
    if(shotLocations$A3[i-1] == leavePlayer){
      shotLocations$A3[i] == enterPlayer
    }
    if(shotLocations$A4[i-1] == leavePlayer){
      shotLocations$A4[i] == enterPlayer
    }
    if(shotLocations$A4[i-1] == leavePlayer){
      shotLocations$A4[i] == enterPlayer
    }
    if(shotLocations$A5[i-1] == leavePlayer){
      shotLocations$A5[i] == enterPlayer
    }
    
    subsCounter <- subsCounter + 1
    }

  }else{
    #There has not been a sub since the last shot
    shotLocations$H1[i] <- shotLocations$H1[i-1]
    shotLocations$H2[i] <- shotLocations$H2[i-1]
    shotLocations$H3[i] <- shotLocations$H3[i-1]
    shotLocations$H4[i] <- shotLocations$H4[i-1]
    shotLocations$H5[i] <- shotLocations$H5[i-1]
    shotLocations$A1[i] <- shotLocations$A1[i-1]
    shotLocations$A2[i] <- shotLocations$A2[i-1]
    shotLocations$A3[i] <- shotLocations$A3[i-1]
    shotLocations$A4[i] <- shotLocations$A4[i-1]
    shotLocations$A5[i] <- shotLocations$A4[i-1]
  }
   
    
     
  }
}


    
    
    
```


shotLocations$H1<- ""
    shotLocations$H2 <- 0
    shotLocations$H3<- 0
    shotLocations$H4<- 0
    shotLocations$H5<- 0
    shotLocations$A1<- 0
    shotLocations$A2<- 0
    shotLocations$A3<- 0
    shotLocations$A4<- 0
    shotLocations$A5<- 0
    shotLocations

EXTRA CODE:
findHome <- gregexpr("home_team_id", data)
homeTeam <- substr(data, findHome[[1]] + 21, findHome[[1]] + 22)

if(grepl(",", homeTeam)){
  findComma <- gregexpr(",", homeTeam)
  homeTeam <- substr(homeTeam, 1, findComma[[1]] - 1)
}

findAway <- gregexpr("away_team_id", data)
awayTeam <- substr(data, findAway[[1]] + 21, findAway[[1]] + 22)

if(grepl(",", awayTeam)){
  findComma <- gregexpr(",", awayTeam)
  awayTeam <- substr(awayTeam, 1, findComma[[1]] - 1)
}

homeTeam <- as.numeric(homeTeam)
awayTeam <- as.numeric(awayTeam)

awayTeam


EXTRA:

An attempt to check if it is a free throw - was not working 
findFreeThrow <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 450)
ft <- grepl("free throw", findFreeThrow)
shotLocations$FreeThrow[i] <- ft



EXTRA: Home score works but away score doesnt
awayscoreChr <- gregexpr("away_score", fullString)
findAwayScore <- substr(fullString, awayscoreChr[[1]]+13, awayscoreChr[[1]] + 15)
if(grepl(",", findAwayScore)){
  findComma <- gregexpr(",", findAwayScore)
  findAwayScore <- substr(findAwayScore, 1, findComma[[1]] - 2)
}
y <- substr(findAwayScore, 3, 3)
if(!is.empty(y)){
  findAwayScore <- substr(findAwayScore, 1, 2)
}
findAwayScore <- as.numeric(findAwayScore)
shotLocations$AwayScore[i] <- findAwayScore




