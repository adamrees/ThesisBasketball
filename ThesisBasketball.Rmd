---
title: "Thesis"
author: "Adam Rees"
date: "October 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rvest)
library(dplyr)
require(XML)
require(RCurl)
require(stringr)
require(png)
library(XML)

library(sp)
library(gstat)

#install.packages('rapportools')
library(rapportools)

```

#URLs for all the games between 1/1 - 1/2
url1 <- getURL("https://sports.yahoo.com/nba/orlando-magic-washington-wizards-2020010127/?section=gamestream")
url2 <- getURL("https://sports.yahoo.com/nba/portland-trail-blazers-new-york-knicks-2020010118/?section=gamestream")
url3 <- getURL("https://sports.yahoo.com/nba/minnesota-timberwolves-milwaukee-bucks-2020010115/?section=gamestream")
url4 <- getURL("https://sports.yahoo.com/nba/phoenix-suns-los-angeles-lakers-2020010113/?section=gamestream")
url5 <- getURL("https://sports.yahoo.com/nba/charlotte-hornets-cleveland-cavaliers-2020010205/?section=gamestream")
url6 <- getURL("https://sports.yahoo.com/nba/denver-nuggets-indiana-pacers-2020010211/?section=gamestream")
url7 <- getURL("https://sports.yahoo.com/nba/toronto-raptors-miami-heat-2020010214/?section=gamestream")
url8 <- getURL("https://sports.yahoo.com/nba/utah-jazz-chicago-bulls-2020010204/?section=gamestream")
url9 <- getURL("https://sports.yahoo.com/nba/golden-state-warriors-minnesota-timberwolves-2020010216/?section=gamestream")
url10 <- getURL("https://sports.yahoo.com/nba/brooklyn-nets-dallas-mavericks-2020010206/?section=gamestream")
url11 <- getURL("https://sports.yahoo.com/nba/oklahoma-city-thunder-san-antonio-spurs-2020010224/?section=gamestream")
url12 <- getURL("https://sports.yahoo.com/nba/memphis-grizzlies-sacramento-kings-2020010223/?section=gamestream")
url13 <- getURL("https://sports.yahoo.com/nba/detroit-pistons-los-angeles-clippers-2020010212/?section=gamestream")

```{r}
url1 <- getURL("https://sports.yahoo.com/nba/new-york-knicks-san-antonio-spurs-2019102324/?section=gamestream")
url2 <- getURL("https://sports.yahoo.com/nba/washington-wizards-san-antonio-spurs-2019102624/?section=gamestream")
url3 <- getURL("https://sports.yahoo.com/nba/portland-trail-blazers-san-antonio-spurs-2019102824/?section=gamestream")
url4 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-los-angeles-clippers-2019103112/?section=gamestream")
url5 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-golden-state-warriors-2019110109/?section=gamestream")
url6 <- getURL("https://sports.yahoo.com/nba/los-angeles-lakers-san-antonio-spurs-2019110324/?section=gamestream")
url7 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-atlanta-hawks-2019110501/?section=gamestream")
url8 <- getURL("https://sports.yahoo.com/nba/oklahoma-city-thunder-san-antonio-spurs-2019110724/?section=gamestream")
url9 <- getURL("https://sports.yahoo.com/nba/boston-celtics-san-antonio-spurs-2019110924/?section=gamestream")
url10 <- getURL("https://sports.yahoo.com/nba/memphis-grizzlies-san-antonio-spurs-2019111124/?section=gamestream")
url11 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-minnesota-timberwolves-2019111316/?section=gamestream")
url12 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-orlando-magic-2019111519/?section=gamestream")
url13 <- getURL("https://sports.yahoo.com/nba/portland-trail-blazers-san-antonio-spurs-2019111624/?section=gamestream")
url14<- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-dallas-mavericks-2019111806/?section=gamestream")
url15<- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-washington-wizards-2019112027/?section=gamestream")
url16 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-philadelphia-76ers-2019112220/?section=gamestream")
url17 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-new-york-knicks-2019112318/?section=gamestream")
url18 <- getURL("https://sports.yahoo.com/nba/los-angeles-lakers-san-antonio-spurs-2019112524/?section=gamestream")
url19 <- getURL("https://sports.yahoo.com/nba/minnesota-timberwolves-san-antonio-spurs-2019112724/?section=gamestream")
url20 <- getURL("https://sports.yahoo.com/nba/los-angeles-clippers-san-antonio-spurs-2019112924/?section=gamestream")
url21 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-detroit-pistons-2019120108/?section=gamestream")
url22 <- getURL("https://sports.yahoo.com/nba/houston-rockets-san-antonio-spurs-2019120324/?section=gamestream")
url23 <- getURL("https://sports.yahoo.com/nba/sacramento-kings-san-antonio-spurs-2019120624/?section=gamestream")
url24 <- getURL("https://sports.yahoo.com/nba/cleveland-cavaliers-san-antonio-spurs-2019121224/?section=gamestream")
url25 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-phoenix-suns-2019121421/?section=gamestream")
url26 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-houston-rockets-2019121610/?section=gamestream")
url27 <- getURL("https://sports.yahoo.com/nba/brooklyn-nets-san-antonio-spurs-2019121924/?section=gamestream")
url28 <- getURL("https://sports.yahoo.com/nba/los-angeles-clippers-san-antonio-spurs-2019122124/?section=gamestream")
url29 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-memphis-grizzlies-2019122329/?section=gamestream")
url30 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-dallas-mavericks-2019122606/?section=gamestream")
url31 <- getURL("https://sports.yahoo.com/nba/detroit-pistons-san-antonio-spurs-2019122824/?section=gamestream")
url32 <- getURL("https://sports.yahoo.com/nba/golden-state-warriors-san-antonio-spurs-2019123124/?section=gamestream")
url33 <- getURL("https://sports.yahoo.com/nba/oklahoma-city-thunder-san-antonio-spurs-2020010224/?section=gamestream")
url34 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-milwaukee-bucks-2020010415/?section=gamestream")
url35 <- getURL("https://sports.yahoo.com/nba/milwaukee-bucks-san-antonio-spurs-2020010624/?section=gamestream")
url36 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-boston-celtics-2020010802/?section=gamestream")
url37 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-memphis-grizzlies-2020011029/?section=gamestream")
url38 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-toronto-raptors-2020011228/?section=gamestream")
url39 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-miami-heat-2020011514/?section=gamestream")
url40 <- getURL("https://sports.yahoo.com/nba/atlanta-hawks-san-antonio-spurs-2020011724/?section=gamestream")
url41 <- getURL("https://sports.yahoo.com/nba/miami-heat-san-antonio-spurs-2020011924/?section=gamestream")
url42 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-phoenix-suns-2020012021/?section=gamestream")
url43 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-new-orleans-pelicans-2020012203/?section=gamestream")
url44 <- getURL("https://sports.yahoo.com/nba/phoenix-suns-san-antonio-spurs-2020012424/?section=gamestream")
url45 <- getURL("https://sports.yahoo.com/nba/toronto-raptors-san-antonio-spurs-2020012624/?section=gamestream")
url46 <- getURL("https://sports.yahoo.com/nba/san-antonio-spurs-chicago-bulls-2020012704/?section=gamestream")
url47 <- getURL("https://sports.yahoo.com/nba/utah-jazz-san-antonio-spurs-2020012924/?section=gamestream")
url48 <- getURL("https://sports.yahoo.com/nba/charlotte-hornets-san-antonio-spurs-2020020124/?section=gamestream")



```





Getting the original data up. Pull in what URL you want and work from there
```{r}


url <- url48

#who is the home team
l <- gregexpr("?section", url)[[1]][1]
homeTeam <- substr(url, l - 4, l-3)


#Character where JUMPBALL happened
postJump <- gregexpr("JUMPBALL", url)
#the string before the JUMPBALL - needed to get the starters
starterStuff <- substr(url, 1, postJump[[1]][1])
players <- gregexpr("on_court", starterStuff)
playerIDs <- c()
starters <- c()

for(i in 1:length(players[[1]])){

#get all of the players IDS
playerIDs[i] <- substr(starterStuff, players[[1]][i] - 7, players[[1]][i] -4)

checkStarter <- substr(starterStuff, players[[1]][i] + 23, players[[1]][i] + 23)

#Identify if they are a starter or not
if(grepl(checkStarter, "0")){
  starters[i] <- FALSE 
  } else{
  starters[i] <- TRUE
}
}


startingLineups <- data.frame(playerIDs, starters)
justStarters <- startingLineups %>% filter(starters == TRUE)
startingIDs <- c()
for(i in 1:nrow(justStarters)){
  startingIDs[i] <- toString(justStarters$playerIDs[i])
}
startingIDs

#We only want the data after the jump for the gameStream
data <- substr(url, postJump[[1]], nchar(url))





#Get all of the characters where shots were taken
shots <- gregexpr("SHOT", data)


newShots <- shots[[1]]
subs <- gregexpr("SUB", data)


#get rid of the NAs
newShots <- newShots[!is.na(newShots)]

#all of the characters where player is mentioned (could be for anything)
player <- gregexpr("player", data)
shotChar <- c()

#Match the player to the shooter
for (i in 1:length(newShots)){
  shotChar[i] <- player[[1]][which(player[[1]] > newShots[i] & player[[1]] < newShots[i]+47)]
}


shooterID <- c()
for(i in 1:length(shotChar)){
  shooterID[i] <- substr(data,shotChar[i]+9,shotChar[i]+12)
}

#data frame with every single shot and who shot it
shotAndShooter <- tibble(shotChar, shooterID)

#you can add a filter here
shotLocations <- shotAndShooter




#Build a dataset for all of the subs
subChars <- append(0,subs[[1]])
allSubs <- data.frame(subChars)
numSubs <- length(allSubs[[1]])

for(i in 1:numSubs){

  if(i == 1){
    allSubs$H1[1]<- startingIDs[1]
    allSubs$H2[1]<- startingIDs[2]
    allSubs$H3[1]<- startingIDs[3]
    allSubs$H4[1]<- startingIDs[4]
    allSubs$H5[1]<- startingIDs[5]
    allSubs$A1[1]<- startingIDs[6]
    allSubs$A2[1]<- startingIDs[7]
    allSubs$A3[1]<- startingIDs[8]
    allSubs$A4[1]<- startingIDs[9]
    allSubs$A5[1]<- startingIDs[10]
  }
  else{
  
    
    
    #find the players that are getting subbed in and subbed out
findPlayer <- substr(data, allSubs$subChars[i], allSubs$subChars[i] + 150)
findPlayer
playerEnter <- gregexpr("enter_player", findPlayer)
playerLeave <- gregexpr("leave_player", findPlayer)

enterPlayer <- substr(findPlayer, playerEnter[[1]] + 15, playerEnter[[1]] + 18)
leavePlayer <- substr(findPlayer, playerLeave[[1]] + 15, playerLeave[[1]] + 18)
    
    if(allSubs$H1[i-1] == leavePlayer){
      allSubs$H1[i] <- enterPlayer
    }else{
      allSubs$H1[i] <- allSubs$H1[i-1]
    }
    if(allSubs$H2[i-1] == leavePlayer){
      allSubs$H2[i] <- enterPlayer
    }else{
      allSubs$H2[i] <- allSubs$H2[i-1]
    }
    if(allSubs$H3[i-1] == leavePlayer){
      allSubs$H3[i] <- enterPlayer
    }else{
      allSubs$H3[i] <- allSubs$H3[i-1]
    }
    if(allSubs$H4[i-1] == leavePlayer){
      allSubs$H4[i] <- enterPlayer
    }else{
      allSubs$H4[i] <- allSubs$H4[i-1]
    }
    if(allSubs$H5[i-1] == leavePlayer){
      allSubs$H5[i] <- enterPlayer
    }else{
      allSubs$H5[i] <- allSubs$H5[i-1]
    }
    if(allSubs$A1[i-1] == leavePlayer){
      allSubs$A1[i] <- enterPlayer
    }else{
      allSubs$A1[i] <- allSubs$A1[i-1]
    }
    if(allSubs$A2[i-1] == leavePlayer){
      allSubs$A2[i] <- enterPlayer
    }else{
    allSubs$A2[i] <- allSubs$A2[i-1]
    }
    if(allSubs$A3[i-1] == leavePlayer){
      allSubs$A3[i] <- enterPlayer
    }else{
      allSubs$A3[i] <- allSubs$A3[i-1]
    }
    if(allSubs$A4[i-1] == leavePlayer){
      allSubs$A4[i] <- enterPlayer
    }else{
      allSubs$A4[i] <- allSubs$A4[i-1]
    }
    if(allSubs$A5[i-1] == leavePlayer){
      allSubs$A5[i] <- enterPlayer
    }else{
      allSubs$A5[i] <- allSubs$A5[i-1]
    }
  
    
  }
    
}

    

#number of shots taken in the game
numShots <- nrow(shotLocations)


for(i in 1:numShots){

shotLocations$HomeTeam[i] <- homeTeam

fullString <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 450)

timeChr <- gregexpr("clock", fullString)
findTime <- substr(fullString, timeChr[[1]]+8, timeChr[[1]] + 12)

if(!substr(findTime, 1, 1) == "1" | substr(findTime, 1, 2) == "1:"){
  findTime <- substr(findTime, 1, 4)
}
if(substr(findTime, 1, 1) == ":"){
  findTime <- paste("0", substr(findTime, 1, 3), sep = "") 
}

shotLocations$Time[i] <- findTime

periodString <- substr(data, shotLocations$shotChar[i]-50, shotLocations$shotChar[i])
periodChr <- gregexpr("period", periodString)
findPeriod <- substr(periodString, periodChr[[1]]+9, periodChr[[1]] + 9)

shotLocations$Period[i] <- findPeriod



# Find the score for the home team
homescoreChr <- gregexpr("home_score", fullString)
findHomeScore <- substr(fullString, homescoreChr[[1]]+13, homescoreChr[[1]] + 15)
if(grepl(",", findHomeScore)){
  findComma <- gregexpr(",", findHomeScore)
  findHomeScore <- substr(findHomeScore, 1, findComma[[1]] - 2)
}
x <- substr(findHomeScore, 3, 3)
if(is.na(as.numeric(x)) & !is.empty(x)){
  findHomeScore <- substr(findHomeScore, 1, 2)
}

shotLocations$HomeScore[i] <- findHomeScore

fStr <- substr(data, shotLocations$shotChar[i] - 25, shotLocations$shotChar[i])

awayScoreChr <- gregexpr("away_score", fStr)
findAwayScore <- substr(fStr, awayScoreChr[[1]] + 13, awayScoreChr[[1]] + 18)

if(grepl(",", findAwayScore)){
  findComma <- gregexpr(",", findAwayScore)
  findAwayScore <- substr(findAwayScore, 1, findComma[[1]] - 2)
}

shotLocations$AwayScore[i] <- findAwayScore

    
#Find the baseline offset by getting a large string after the shot, finding where it says baseline offset and taking the number after it
findBaseline <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 120)
charBaseline <- gregexpr("baseline_offset", findBaseline)
baseString <- substr(findBaseline, charBaseline[[1]] + 28, charBaseline[[1]] + 34)

#baseline offset could be 0 to 4 characters - we want to just grab the number
if(grepl(",", baseString)){
  findComma <- gregexpr(",", baseString)
  baseString <- substr(baseString, 1, findComma[[1]] - 1)
}

#Same code but now for sideline offset
findSideline <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 300)
charSideline <- gregexpr("sideline_offset", findSideline)
sideString <- substr(findSideline, charSideline[[1]] + 28, charSideline[[1]] + 33)

if(grepl(",", sideString)){
 findComma <- gregexpr(",", sideString)
 sideString <- substr(sideString, 1, findComma[[1]] - 1)
}
 
#they were characters but we want it to be a double
shotLocations$baselineOffset[i] <- as.numeric(baseString)
shotLocations$sidelineOffset[i] <- as.numeric(sideString)

#find if the shot was made or missed
findMakeMiss <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 460)
makeMiss <- gregexpr("shot_made", findMakeMiss)
makeMiss <- substr(findMakeMiss, makeMiss[[1]] + 12, makeMiss[[1]] + 12)

#find if the shot was a 3 or a 2
shotType <- gregexpr("points", findMakeMiss)
shotType <- substr(findMakeMiss, shotType[[1]] + 9, shotType[[1]] + 9)
shotLocations$shotType[i] <- as.double(shotType)

#find what team the player was on
findTeam <- substr(data, shotLocations$shotChar[i], shotLocations$shotChar[i] + 460)
teamCharacter <- gregexpr("team", findTeam)
team <- substr(findTeam, teamCharacter[[1]] + 7, teamCharacter[[1]] + 8)

if(is.na(as.numeric(team))){
 team <- substr(team, 1, 1)
}

shotLocations$Team[i] <- team

if(makeMiss == "1"){
  shotLocations$MakeMiss[i] <- 1
} else{
  shotLocations$MakeMiss[i] <- 0
}

#we now need to find what side of the basket the shot was taken. This is needed because the baseline offset is the same number for different sides of the basket
shotLocations$sideBasket[i] <- substr(data, shotLocations$shotChar[i] + 62, shotLocations$shotChar[i] + 62)

#use this to create a new variable plotting the X Location
if(shotLocations$sideBasket[i] == 'R'){
  shotLocations$X_LOC[i] <- as.double(shotLocations$baselineOffset[i] * 500)
} else{
  shotLocations$X_LOC[i] <- as.double(-1 * shotLocations$baselineOffset[i] * 500)
}

#also want the y location
shotLocations$Y_LOC[i] <- shotLocations$sidelineOffset[i] * 850

}

#get the home and away teams
teams <- unique(shotLocations$Team)
#set the opposing team
shotLocations$OpposingTeam <- ifelse(shotLocations$Team == teams[1], teams[2], teams[1])


#even after the for loop some X vals where characters - make sure they are doubles
shotLocations$X_LOC <- as.double(shotLocations$X_LOC)




#Filter out Free Throws
shotsNoFT <- shotLocations %>% filter(!(shotLocations$sidelineOffset == 0.1573 & shotLocations$baselineOffset == 0.00))


#coordinates(shotsNoFT) <- ~X_LOC + Y_LOC
makes <- shotsNoFT %>% filter(shotsNoFT$MakeMiss == 1)
misses <- shotsNoFT %>% filter(shotsNoFT$MakeMiss == 0)


coordinates(makes) <- ~X_LOC + Y_LOC
coordinates(misses) <- ~X_LOC + Y_LOC

#plot(makes, pch = 1)
#points(misses, pch = 4)

    shotsNoFT$H1<- ""
    shotsNoFT$H2<- ""
    shotsNoFT$H3<- ""
    shotsNoFT$H4<- ""
    shotsNoFT$H5<- ""
    shotsNoFT$A1<- ""
    shotsNoFT$A2<- ""
    shotsNoFT$A3<- ""
    shotsNoFT$A4<- ""
    shotsNoFT$A5<- ""

 currentLineUp <- 1
 maxSub <- length(allSubs[[1]])
 maxShot <- length(shotsNoFT[[1]])
 
for(i in 1:maxShot){
  #first, find what index of the subs players you want to use
  while(currentLineUp < maxSub & shotsNoFT$shotChar[i] > allSubs$subChars[currentLineUp + 1]){
    currentLineUp <- currentLineUp + 1
  }
  
  
  #update shotsNoFT to that index
    shotsNoFT$H1[i]<- allSubs$H1[currentLineUp]
    shotsNoFT$H2[i]<- allSubs$H2[currentLineUp]
    shotsNoFT$H3[i]<- allSubs$H3[currentLineUp]
    shotsNoFT$H4[i]<- allSubs$H4[currentLineUp]
    shotsNoFT$H5[i]<- allSubs$H5[currentLineUp]
    shotsNoFT$A1[i]<- allSubs$A1[currentLineUp]
    shotsNoFT$A2[i]<- allSubs$A2[currentLineUp]
    shotsNoFT$A3[i]<- allSubs$A3[currentLineUp]
    shotsNoFT$A4[i]<- allSubs$A4[currentLineUp]
    shotsNoFT$A5[i]<- allSubs$A5[currentLineUp]


}
 
 shotsNoFT$pointsPerShot <- shotsNoFT$MakeMiss*currentGame$shotType

 
 currentGame <- shotsNoFT

(currentGame)

fullData <- rbind(currentGame, fullData)

fullData


#Need to build two datasets, one with Player X on the court and one without
#playerX <- "6163"
#xInGame <- finalShots %>% filter(H1 == playerX | H2 == playerX | H3 == playerX | H4 == playerX | H5 == playerX)
#xInGame
```



```{r}

# Added in new variables to find out the minutes left 

for(i in 1: nrow(fullData)){
fullData$winning[i] <- (fullData$HomeTeam[i] == "24" && (as.numeric(fullData$HomeScore[i]) > as.numeric(fullData$AwayScore[i]))) || (fullData$HomeTeam[i] != "24" && (as.numeric(fullData$HomeScore[i]) < as.numeric(fullData$AwayScore[i])))


x <- ifelse(grepl(":", substr(fullData$Time[i], 1, 2)), substr(fullData$Time[i], 1, 1), substr(fullData$Time[i], 1, 2))

fullData$lessFive[i] <- as.numeric(x)

}

#Final dataset
fullData
```


Randomization Test
```{r}
#Seperate into 2 different dataset

oneQuarter <- filter(fullData, Period == "4", winning == FALSE, lessFive < 5)
otherQ <- filter(fullData, Period != "4" | winning != FALSE | lessFive >= 5)


#need to make sure there is equal spacing
oneQ <- kde2d(oneQuarter$X_LOC, oneQuarter$Y_LOC, lims = c(-250, 250, -20, 375))
oneQ
otherQs <- kde2d(otherQ$X_LOC, otherQ$Y_LOC, lims = c(-250, 250, -20, 375))

checkVal<- sum(abs(oneQ$z - otherQs$z))



store <- c()
reps <- 1000


for(i in 1:reps){
  x <- sample_n(fullData, size = nrow(fullData))
  a <- x[1:shotsInQTR + 0,]
  b <- x[478: 8493,]
  
  
  randomOne <- kde2d(a$X_LOC, a$Y_LOC, lims = c(-250, 250, -20, 375))
  randomTwo <- kde2d(b$X_LOC, b$Y_LOC, lims = c(-250, 250, -20, 375))

  
  value <- sum(abs(randomOne$z - randomTwo$z))
  store <- c(store, value)
  
}


mean(store > checkVal)


```


Visualizations
```{r}
persp(oneQ, theta = 45, phi = 55)
persp(otherQs, theta = 45, phi = 55)

differential <- differential * 1000

persp(oneQ$x, oneQ$y, differential, 
  theta = 30, phi = 30, expand = 0.19, scale=FALSE,
  shade=NA, col=colors[z.facet.range], border="grey80",
  box=FALSE, zlim = c(min(differential), max(differential)))

persp(differential, theta=45, phi=30)

persp(differential, theta=55, phi=30)

x <- seq(-250, 250, by = 25)
y <- seq(-20, 375, by = 25)


```





```{r}

differential <- oneQ$z/sum(oneQ$z) - otherQs$z/sum(otherQs$z)

colorTable<- designer.colors(20, c( "blue","lightblue", "pink"  ,"red") )
image.plot(differential, col=colorTable)

#clim = c(-.012, .004)
persp(differential, theta = 15, phi= 40)

persp3D(oneQ$x, oneQ$y, differential, theta = 15, phi = 40, expand = 0.6, col = colorTable, colkey = TRUE, clim = c(-.012, .004))
```


```{r}

library(MASS)
library (tmvtnorm)
bivn <- mvrnorm(1000, mu = c(0, 0), Sigma = matrix(c(1, .5, .5, 1), 2))
bivn2 <- mvrnorm(1000, mu = c(0, 0), Sigma = matrix(c(1.5, 1.5, 1.5, 1.5), 2))

# now we do a kernel density estimate
bivn.kde <- kde2d(bivn[,1], bivn[,2], n = 50)
bivn.kde2 <- kde2d(bivn2[,1], bivn[,2], n = 50)

# fancy perspective
persp(bivn.kde, phi = 45, theta = 20, shade = .4, border = NA)
par(new=TRUE)
persp(bivn.kde2, phi = 45, theta = 20, shade = .1, border = NA)





```
```{r}
bivn <- mvrnorm(1000, mu = c(0, 0), Sigma = matrix(c(1, .5, .5, 1), 2))

# now we do a kernel density estimate
bivn.kde <- kde2d(bivn[,1], bivn[,2], n = 50)

# now plot your results
contour(bivn.kde)
image(bivn.kde)
persp(bivn.kde, phi = 45, theta = 30)

# fancy contour with image
image(bivn.kde); contour(bivn.kde, add = T)

# fancy perspective
persp(bivn.kde, phi = 45, theta = 30, shade = .1, border = NA)
```

```{r}
---
title: "Who started the Quarter"
author: "TACKO FALL"
date: "2/15/2020"
output: pdf_document
---

```


Load in the game stream
```{r}
url <- getURL("https://nam01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fsports.yahoo.com%2Fnba%2Foklahoma-city-thunder-new-orleans-pelicans-2020021303%2F%3Fsection%3Dgamestream&amp;data=02%7C01%7Casra2016%40mymail.pomona.edu%7Ce7770d64264d484d0d4d08d7b3d3bd0f%7C817f590439044ee8b3a5a65d4746ff70%7C0%7C0%7C637175594304714962&amp;sdata=dy37PspODCe8ZvUcSfHaRGCixkBNhNg%2FkQ80tgXRkyM%3D&amp;reserved=0")
```

Find out when each quarter ends - end of second quarter doesn't follow pattern
```{r}
q1 <- gregexpr("End of 1st Quarter", url)[[1]][1]
q2 <- gregexpr("Halftime", url)[[1]]
q3 <- gregexpr("End of 3rd Quarter", url)[[1]][1]
q4 <- gregexpr("End of 4th Quarter", url)[[1]][1]
q2 <- q2[which(q2 > q1 & q2 <q3) ]
quarters <- c(q1,q2,q3,q4)
```

A function that turns a game time MM:SS into a numeric variable of seconds
```{r}
to.seconds <- function(time) {
  colon <- gregexpr(":", time)[[1]]
  min <- as.numeric(substr(time, 1,(colon-1)))
  sec <- as.numeric(substr(time,colon+1,47))
  min*60+sec
}
```

Grab only the relevant gamestream section
```{r}
what.q <- 2
qurl <- substr(url,quarters[what.q-1], quarters[what.q])
```

Find out who recorded a stat in that quarter
```{r}
player <- gregexpr("nba.p.", qurl)
ingame <- c()
for (i in 1:length(player[[1]]))
  ingame[i] <- substr(qurl, player[[1]][i]+6, player[[1]][i]+9)
```

Find out when the subs happened, and who entered and who exited
```{r}
sub <- gregexpr("enters game", qurl)[[1]]
sub.times <- c()
sub.times.sec <- c()
for (i in 1:length(sub)) {
  sub.times[i] <- substr(qurl, sub[i]+39, sub[i]+43)
  if (substr(sub.times[i],2,2)==":")
    sub.times[i] <- substr(sub.times[i],1,4)
  sub.times.sec[i] <- to.seconds(sub.times[i])
}

enter <- c()
exit <- c()
for (i in 1:length(sub)) {
  enter[i] <- ingame[which.max(1:length(player[[1]])*(player[[1]]<sub[i]))]
  exit[i] <- ingame[which.max(1:length(player[[1]])*(player[[1]]<sub[i]))+1]
}
```

If they never were recorded as entering or the first thing they did was exited, they must have started the Q
```{r}
subbed <- unique(c(enter, exit))
start.quarter <- c()
for (i in 1:length(subbed)) {
  if (sum(enter==subbed[i])==0) {
    start.quarter <- c(start.quarter, subbed[i])
  }
    if (sum(enter==subbed[i])>0 & sum(exit==subbed[i])>0) {
      if (min(sub.times.sec[enter==subbed[i]]) < min(sub.times.sec[exit==subbed[i]]))
            start.quarter <- c(start.quarter, subbed[i])
    }
}
```

If someone plays the whole quarter, we find them by in-game stats rather than subs
```{r}
if (length(start.quarter) < 10) {
  ingame.u <- unique(ingame)
  for (i in 1:length(ingame.u)) {
    if (sum(ingame.u[i]==subbed)==0)
      start.quarter <- c(start.quarter, ingame.u)
  }
}
```

I don't know who plays for what team, hopefully you do
```{r}
start.quarter
```




```{r}



x1 <- currentGame$X_LOC
x2 <- currentGame$Y_LOC
y <- currentGame$pointsPerShot

#put the if .. 
rbf.k <- function(x,y,sigma)
  return(exp(-1/(2*sigma^2)*(sum((x-y)^2))))

gpreg <- function(x, y, lam, sig, design) {
  # Evaluates mean and covariance of GP at grid of points on [0,1]
  # Inputs:
  # x, y: input and output values of data set
  # lam: smoothing parameter in RBF kernel
  # sig: error standard deviation of y
  # design: grid of points to evaluate the GP
  # Returns:
  # mean=posterior mean, vars=posterior variance, and design=evaluation points
  n <- length(y)
  Sigma <- matrix(0,nrow=n+nrow(design), ncol=n+nrow(design))
  all <- rbind(x, design)
  for (i in 1:nrow(Sigma)) {
    for (j in i:nrow(Sigma))
      Sigma[i,j] <- rbf.k(all[i,], all[j,], lam) -> Sigma[j,i]
  }
  S11 <- Sigma[1:n, 1:n]
  S12 <- Sigma[1:n, (n+1):ncol(Sigma)]
  S21 <- Sigma[(n+1):ncol(Sigma), 1:n]
  S22 <- Sigma[(n+1):ncol(Sigma),(n+1):ncol(Sigma)]
  inv <- S21%*%solve(S11+sig^2*diag(n))
  mean <- inv%*%y
  cov <- S22-inv%*%S12
  vars <- diag(cov)
  return(list(mean=mean, vars=vars))
}








grid.a <- seq(-250,250,10)
grid.b <- seq(-10,490,10)
grid <- c()
for (i in 1:length(grid.a)) {
  for (j in 1:length(grid.b)) {
    grid <- rbind(grid, c(grid.a[i], grid.b[j]))
  }
}

start.time <- Sys.time()
x <- cbind(x1,x2)
fit <- gpreg(x, y, lam=30, sig=.5, design=grid)
end.time <- Sys.time()
end.time-star.time

k <- 1
mean.fit <- matrix(0, nrow=length(grid.a), ncol=length(grid.b))
for (i in 1:length(grid.a)) {
  for (j in 1:length(grid.b)) {
    mean.fit[i,j] <- fit$mean[k]
    k <- k + 1
  }
}
persp(grid.a, grid.b, mean.fit, theta=60, phi=60)
image(grid.a, grid.b, mean.fit)

```

Error in solve.default(S11 + sig^2 * diag(n)) : 'a' is 0-diml

-250
[1] -28.05
[1] 250
[1] 744.94










